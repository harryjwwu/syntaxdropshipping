# 订单数据验证规则

## 📋 验证规则概览

订单Excel导入时会对数据进行严格验证，确保数据质量和系统稳定性。

## 🔴 必需字段验证

### 普通订单（非退款订单）
以下字段**必须存在且不能为空**：

| 字段名 | 中文名称 | 说明 |
|--------|----------|------|
| `dxm_order_id` | 订单号 | DXM系统的订单号 |
| `country_code` | 国家代码 | 买家所在国家的代码 |
| `product_count` | 产品数量 | 订单中的商品数量 |
| `buyer_name` | 买家姓名 | 购买者的姓名 |
| `payment_time` | 付款时间 | 订单付款的时间 |
| `order_status` | 订单状态 | 当前订单的处理状态 |

### 已退款订单特殊规则
对于订单状态包含"退款"、"refund"或"refunded"的订单，**仅需验证以下字段**：

| 字段名 | 中文名称 | 说明 |
|--------|----------|------|
| `dxm_order_id` | 订单号 | 用于识别订单 |
| `order_status` | 订单状态 | 确认是退款状态 |

## 📏 格式验证规则

### 1. 订单号格式验证
- **标准格式**: `数字-数字`
- **示例**: `7268217-3290`
- **说明**: 前面是DXM客户ID，后面是真实订单ID
- **错误类型**:
  - 不包含"-"分隔符
  - 分隔后不是恰好2部分
  - 包含非数字字符

### 2. 付款时间验证
- **格式要求**: 有效的日期时间格式
- **示例**: `2025-08-17 15:59:44`
- **说明**: 可以被JavaScript Date对象正确解析

## 🟢 可选字段

以下字段为可选，可以为空：
- `product_name` - 产品名称
- `waybill_number` - 运单号
- `product_sku` - 商品SKU
- `product_spu` - 商品SPU
- `product_parent_spu` - 替换SPU
- `unit_price` - 单价
- `multi_total_price` - 总价
- `discount` - 折扣
- `settlement_amount` - 结算金额
- `remark` - 备注信息
- `settle_remark` - 结算说明

## 📊 验证结果统计

当前Excel文件验证结果：
- **总订单数**: 10,210条
- **验证通过**: 10,137条 (99.3%)
- **验证失败**: 73条 (0.7%)

主要失败原因：订单号格式不符合"数字-数字"标准

## 🛠️ 技术实现

验证逻辑位于：`server/utils/orderExcelParser.js` 的 `validateOrders` 方法

### 验证流程：
1. 检查订单状态是否为退款订单
2. 根据订单类型应用不同的必需字段验证
3. 对所有订单进行格式验证
4. 返回验证通过和失败的订单列表

### 错误处理：
- 验证失败的订单不会被导入数据库
- 详细的错误信息会在前端展示
- 控制台会输出验证失败的样例订单

## 📝 更新日志

- 2025-08-19: 移除产品数量和买家姓名长度验证
- 2025-08-19: 为已退款订单放宽必需字段验证
- 2025-08-19: 加强订单号格式验证
- 2025-08-19: 添加详细的验证错误提示
