# 订单折扣设置功能使用指南

## 📋 功能概述

订单折扣设置功能允许管理员为已绑定店小秘的用户设置基于24小时内下单数量的折扣规则。

## 🚀 使用步骤

### 1. 启动服务

```bash
# 启动后端服务器
npm run server

# 启动管理后台
npm run admin
```

访问地址：
- 后端API: http://localhost:5001
- 管理后台: http://localhost:3002

### 2. 管理员登录

1. 访问管理后台登录页面
2. 使用管理员账号登录
3. 确保获得有效的管理员token

### 3. 设置用户折扣

1. **进入用户管理页面**
   - 在管理后台导航到"用户管理"

2. **选择目标用户**
   - 只有已绑定店小秘的用户才能设置折扣
   - 未绑定用户的"设置折扣"按钮会显示为灰色

3. **设置折扣规则**
   - 点击"设置折扣"按钮
   - 在弹出的窗口中添加折扣规则
   - 每个规则包含：
     - 最小数量（如：1）
     - 最大数量（如：3）
     - 折扣率（如：0.9 表示9折）

4. **规则验证**
   - 系统会自动检查数量范围是否冲突
   - 折扣率必须在0.01-1.00之间
   - 数量必须为正整数

### 4. 查看折扣规则

1. **用户详情页面**
   - 点击用户的"详情"按钮
   - 在概览标签页中查看"订单折扣"区域

2. **折扣规则展示**
   - 显示店小秘绑定状态
   - 列出所有折扣规则
   - 显示规则说明

## 🛠️ 故障排除

### 常见问题

1. **"获取折扣规则失败"**
   - 检查是否已正确登录管理后台
   - 确认管理员token是否有效
   - 检查服务器是否正常运行

2. **"设置折扣"按钮灰显**
   - 该用户未绑定店小秘客户ID
   - 需要先为用户绑定店小秘

3. **数量范围冲突**
   - 检查新规则的数量范围是否与现有规则重叠
   - 修改数量范围避免冲突

4. **API认证失败**
   - 重新登录管理后台
   - 检查token是否过期
   - 确认API请求包含正确的Authorization头

### 调试信息

- 打开浏览器开发者工具查看控制台日志
- 检查网络请求的响应状态
- 查看服务器终端日志

## 📊 数据结构

### 折扣规则表 (user_discount_rules)

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| dxm_client_id | INT | 店小秘客户ID |
| min_quantity | INT | 最小数量 |
| max_quantity | INT | 最大数量 |
| discount_rate | DECIMAL(3,2) | 折扣率 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### API接口

- `GET /api/admin/user-discount-rules/:dxmClientId` - 获取折扣规则
- `POST /api/admin/user-discount-rules/:dxmClientId` - 创建折扣规则
- `PUT /api/admin/user-discount-rules/:dxmClientId/:ruleId` - 更新折扣规则
- `DELETE /api/admin/user-discount-rules/:dxmClientId/:ruleId` - 删除折扣规则

## 🔧 技术说明

- **认证方式**: JWT Token认证
- **数据验证**: 前后端双重验证
- **冲突检测**: 自动检测数量范围重叠
- **错误处理**: 完整的错误提示和处理机制

## 📝 示例

### 典型折扣规则设置

```
1-3件: 9.0折 (0.90)
4-8件: 8.5折 (0.85)
9-15件: 8.0折 (0.80)
16件以上: 7.5折 (0.75)
```

### 折扣计算逻辑

- 统计用户在24小时内的总下单件数
- 根据总件数匹配对应的折扣规则
- 应用最高匹配的折扣率

---

如有问题，请检查服务器日志或联系开发团队。
